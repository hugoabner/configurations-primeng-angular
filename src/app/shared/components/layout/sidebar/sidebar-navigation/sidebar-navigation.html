<!-- Iterar sobre los grupos del menú -->
@for (group of menuGroups; track group.title) {
  <div class="px-3 pt-4">
    <h3
      class="text-sm font-semibold text-surface-500 dark:text-surface-400 uppercase tracking-wider truncate"
      [ngClass]="{ 'text-center': !desktopOpen }"
    >
      @if (desktopOpen) {
        {{ group.title }}
      } @else {
        <i class="pi pi-ellipsis-h"></i>
      }
    </h3>
  </div>

  <ul class="space-y-1 pt-2">
    @for (item of group.items; track item.href; let i = $index) {
      @if (shouldShowItem(item)) {
        <li
          class="relative group"
          [ngClass]="{ 'sidebar-collapsed': !desktopOpen }"
          (mouseenter)="!desktopOpen ? onItemMouseEnter(item, $event, group.title) : null"
          (mouseleave)="!desktopOpen ? onItemMouseLeave() : null"
        >
          <!-- Item principal -->
          <a
            [routerLink]="!hasSubItems(item) ? item.href : null"
            [routerLinkActive]="!hasSubItems(item) ? 'active' : ''"
            [routerLinkActiveOptions]="{ exact: item.exact || false }"
            (click)="hasSubItems(item) ? toggleSubmenu(item, $event) : navigateAndClose(item)"
            [class.justify-center]="!desktopOpen"
            class="flex items-center rounded-lg p-1.5 text-[16px] transition-colors duration-200 
            font-medium hover:bg-primary-50 dark:hover:bg-primary-900/30 hover:text-primary-700 
            dark:hover:text-primary-300 cursor-pointer"
            [class.bg-primary-50]="
              (!hasSubItems(item) && isLinkActive(item.href || '', item.exact)) ||
              (hasSubItems(item) && isSubmenuActive(item))
            "
            [class.dark:bg-primary-900/30]="
              (!hasSubItems(item) && isLinkActive(item.href || '', item.exact)) ||
              (hasSubItems(item) && isSubmenuActive(item))
            "
            [class.text-primary-700]="
              (!hasSubItems(item) && isLinkActive(item.href || '', item.exact)) ||
              (hasSubItems(item) && isSubmenuActive(item))
            "
            [class.dark:text-primary-300]="
              (!hasSubItems(item) && isLinkActive(item.href || '', item.exact)) ||
              (hasSubItems(item) && isSubmenuActive(item))
            "
            [pTooltip]="!desktopOpen && !hasSubItems(item) ? item.label : ''"
            tooltipPosition="right"
          >
            @if (item.icon) {
              <i
                class="flex items-center rounded-lg p-1.5 text-[16px] transition-colors duration-200 font-medium"
                [ngClass]="item.icon"
                [class.text-primary-600]="
                  (!hasSubItems(item) && isLinkActive(item.href || '', item.exact)) ||
                  (hasSubItems(item) && isSubmenuActive(item))
                "
                [class.dark:text-primary-400]="
                  (!hasSubItems(item) && isLinkActive(item.href || '', item.exact)) ||
                  (hasSubItems(item) && isSubmenuActive(item))
                "
              ></i>
            }

            @if (desktopOpen) {
              <span
                class="text-[16px] truncate transition-opacity duration-200 flex-1"
                [class.font-semibold]="
                  (!hasSubItems(item) && isLinkActive(item.href || '', item.exact)) ||
                  (hasSubItems(item) && isSubmenuActive(item))
                "
              >
                {{ item.label }}
              </span>

              <!-- Flecha para items con subItems -->
              @if (hasSubItems(item)) {
                <i
                  class="ml-auto text-xs transition-all duration-200"
                  [ngClass]="isExpanded(item) ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"
                  [class.text-primary-500]="
                    isExpanded(item) || (hasSubItems(item) && isSubmenuActive(item))
                  "
                ></i>
              }
            }
          </a>

          <!-- Submenús en modo desktop -->
          @if (desktopOpen && hasSubItems(item) && isExpanded(item)) {
            <ul
              class="ml-6 mt-1 space-y-1 border-l-2 border-primary-200 dark:border-primary-800 animate-slideDown"
            >
              @for (subItem of item.subItems; track subItem.href) {
                @if (shouldShowItem(subItem)) {
                  <li>
                    <!-- Subitem recursivo -->
                    <app-sidebar-submenu
                      [item]="subItem"
                      [desktopOpen]="desktopOpen"
                      [level]="1"
                      (navigate)="navigateAndClose(subItem)"
                      (toggle)="toggleSubmenu($event)"
                    />
                  </li>
                }
              }
            </ul>
          }
        </li>
      }
    }
  </ul>
}

<!-- Dropdown flotante para modo collapsed -->
@if (!desktopOpen && hoveredItem() && hasSubItems(hoveredItem()!)) {
  <div
    class="fixed z-50 hidden md:block bg-surface-100 dark:bg-surface-800 rounded-lg shadow-lg min-w-48 max-w-64 animate-slideInLeft"
    [ngStyle]="{
      'left.px': dropdownPosition.left,
      'top.px': dropdownPosition.top,
    }"
    (mouseenter)="onDropdownMouseEnter()"
    (mouseleave)="onDropdownMouseLeave()"
  >
    <div>
      <!-- Cabecera del dropdown -->
      <div class="px-4 py-3 border-b border-surface-200 dark:border-surface-700">
        <span
          class="text-sm font-semibold text-surface-700 dark:text-surface-200 flex items-center gap-2"
        >
          @if (hoveredItem()?.icon) {
            <i [ngClass]="hoveredItem()?.icon"></i>
          }
          {{ hoveredItem()?.label }}
        </span>
        @if (hoveredItemPath()) {
          <span class="text-xs text-surface-500 dark:text-surface-400 block mt-1">
            {{ hoveredItemPath() }}
          </span>
        }
      </div>

      <!-- Lista de submenús -->
      <div class="p-2 max-h-96 overflow-y-auto custom-scrollbar">
        @for (subItem of hoveredItem()?.subItems; track subItem.href) {
          @if (shouldShowItem(subItem)) {
            <div class="mb-1">
              @if (hasSubItems(subItem)) {
                <!-- Subitem con hijos en dropdown -->
                <div class="px-3 py-2 text-sm font-medium text-surface-600 dark:text-surface-300">
                  {{ subItem.label }}
                </div>
                <div class="ml-3 pl-2 border-l border-surface-300 dark:border-surface-600">
                  @for (grandChild of subItem.subItems; track grandChild.href) {
                    <a
                      [routerLink]="grandChild.href"
                      routerLinkActive="active"
                      #submenuLink="routerLinkActive"
                      class="flex items-center gap-3 px-3 py-2 text-sm rounded-md transition-all duration-200 hover:translate-x-1 hover:bg-primary-50 dark:hover:bg-primary-900/30 group cursor-pointer"
                      [class.bg-primary-100]="submenuLink.isActive"
                      [class.text-primary-700]="submenuLink.isActive"
                      [class.dark:bg-primary-900/30]="submenuLink.isActive"
                      [class.font-medium]="submenuLink.isActive"
                    >
                      <!-- (click)="closeDropdown()" -->
                      @if (submenuLink.isActive) {
                        <span class="w-1 h-1 rounded-full bg-primary-500"></span>
                      }
                      <span [class.ml-3]="!submenuLink.isActive">
                        {{ grandChild.label }}
                      </span>
                    </a>
                  }
                </div>
              } @else {
                <!-- Subitem sin hijos -->
                <a
                  [routerLink]="subItem.href"
                  routerLinkActive="active"
                  #submenuLink="routerLinkActive"
                  class="flex items-center gap-3 px-3 py-2.5 text-sm rounded-md transition-all duration-200 hover:translate-x-1 hover:bg-primary-50 dark:hover:bg-primary-900/30 group cursor-pointer"
                  [class.bg-primary-100]="submenuLink.isActive"
                  [class.text-primary-700]="submenuLink.isActive"
                  [class.dark:bg-primary-900/30]="submenuLink.isActive"
                  [class.font-medium]="submenuLink.isActive"
                >
                  <!-- (click)="closeDropdown()" -->
                  @if (submenuLink.isActive) {
                    <span class="w-1 h-1 rounded-full bg-primary-500 mr-2"></span>
                  }
                  @if (subItem.icon) {
                    <i [ngClass]="subItem.icon" class="text-sm"></i>
                  }
                  <span [class.ml-3]="!submenuLink.isActive && !subItem.icon">
                    {{ subItem.label }}
                  </span>
                </a>
              }
            </div>
          }
        }
      </div>
    </div>
  </div>
}
